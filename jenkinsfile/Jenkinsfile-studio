def nuxeo_image_build = ""
def app_name = ""
def nuxeo_image_name = ""

pipeline {
  agent {
    node {
      label 'master'
    }
  }

  options {
    timeout(time: 60, unit: 'MINUTES')
  }

  stages {

    stage('Initialize') {
      steps {
        script {
          openshift.withCluster() {
            openshift.withProject() {
              app_name = env.APP_NAME
              echo "Using project: ${openshift.project()} with app: ${app_name}"
              nuxeo_image_build = env.NUXEO_IMAGE_BUILD
              nuxeo_image_name = env.NUXEO_IMAGE_NAME
            }
          }
        }
      }
    }

    stage('Build Docker image') {
      steps {
        script {
          openshift.withCluster() {
            openshift.withProject() {
              // Build docker image
              openshift.selector("bc", nuxeo_image_build).startBuild("--wait")
              def build_last_version = openshift.selector("bc", nuxeo_image_build).object().status.lastVersion
              def last_build = openshift.selector("builds", "${nuxeo_image_build}-${build_last_version}")
              timeout(10) {
                waitUntil {
                  last_build.object().status.phase == "Complete"
                }
              }

              // Promote to dev
              openshift.tag("${nuxeo_image_name}:latest", "${nuxeo_image_name}:dev")
            }
          }
        }
      }
    }

    stage('Deploy DEV') {
      steps {
        script {
          openshift.withCluster() {
            openshift.withProject() {
              openshiftDeploy(deploymentConfig: "${app_name}-dev-interactive")
              timeout(5) {
                openshift.selector("dc", "${app_name}-dev-interactive").related('pods').untilEach(1) {
                  return (it.object().status.phase == "Running")
                }
              }
            }
          }
        }
      }
    }

    stage('User validation') {
      steps {
        script {
          openshift.withCluster() {
            openshift.withProject() {
              timeout(60) {
                input message: "Do you want to deploy to UAT environment too?", id: "approval"
                openshift.tag("${nuxeo_image_name}:latest", "${nuxeo_image_name}:uat")
              }
            }
          }
        }
      }
    }

    stage('Deploy UAT') {
      steps {
        script {
          openshift.withCluster() {
            openshift.withProject() {
              openshiftDeploy(deploymentConfig: "${app_name}-uat-interactive")
              timeout(5) {
                openshift.selector("dc", "${app_name}-uat-interactive").related('pods').untilEach(1) {
                  return (it.object().status.phase == "Running")
                }
              }
            }
          }
        }
      }
    }

  }

  post {
    always {
      // Clean workspace
      cleanWs()
    }
  }

}
